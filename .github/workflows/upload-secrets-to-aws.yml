name: Dynamic Upload to AWS SSM

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    env:
      # üîê AWS credentials for testing (‚ö†Ô∏è do not use in production)
      AWS_ACCESS_KEY_ID: ASIA2YTIIEU5IJJFY3A7
      AWS_SECRET_ACCESS_KEY: KkFLePEb+SB6tQZJonIazIqXzFhxyjuhD6ZbMHON
      AWS_SESSION_TOKEN: IQoJb3JpZ2luX2VjENL//////////wEaCXVzLXdlc3QtMiJGMEQCIBoPqhqjfP8/H3dt3T0GX+gGiD/CMtQOElPKCvppBcMDAiBbcvfArfX2q1L+/TaWq17eB6mKIk3TlxfcLEtKFugnyCq5Agjr//////////8BEAAaDDc0MDAyNjc1NDM2MiIMRQOqwwN2cFIdHcrdKo0CE0Xp5FTlZl/O+kakK7153ivBX0LmJk9ALhUbpU9jcjs50XDQZLxoFm1OvRRbcdOxlqL+wn5pSgXLOLjk5qhT0vFAYtCp0E1s5uJqK9EU8/+ii6bLV7T5fB/Z27jFL87RlwSMlKwoL7t4ZrmRh6iXX82TYWSXTR/jJ27UMLOIpppC4LcBh6MOJbbH/Gu1rz5CebCd012bEztLRVeIughdSsOcXaibrqOzMHnsA5v3rFLtMXsXCUeIN/x2KU0B7AFuDTrlo0Z0lBmCIguGV9vVC3hlmySUivhSCyI+WPReBFvnZd0/r8Ibr3RnhiClZpim/e8/msv/OPXjNew72tEtW1H7K/k1B2e8s4cTpL0w48j9wwY6ngFYo1t0mx5TQvWgf9gixWD3/YqQg5lwetHvPSFPZtzLbAWEGOFX99m4r38FecuGiAbbh6amb0P0xsG2sk6vLz9297oPMTNgR0yLkUG0cP6TtRjJYi/9XWR14tCu/uFFqg0ne0kTTCDGaN6/6A/MotBSKVrNh+4FeFnDgDlxCIhKctAtIPG1qoCBqSZHdZWZwtUtAUO5pfTk/PmMQTUyvA==
      AWS_REGION: us-west-2

      # ‚úÖ GitHub secrets and variables to upload
      MY_SECRET1: ${{ secrets.MY_SECRET1 }}
      MY_SECRET2: ${{ secrets.MY_SECRET2 }}
      MY_VAR1: ${{ vars.MY_VAR1 }}
      MY_VAR2: ${{ vars.MY_VAR2 }}

      # üß† Comma-separated list of variable names for dynamic use
      SECRET_NAMES: MY_SECRET1,MY_SECRET2
      VAR_NAMES: MY_VAR1,MY_VAR2

    steps:
      - name: Install AWS CLI
        run: |
          sudo apt-get update && sudo apt-get install -y awscli

      - name: Test AWS Credentials
        run: |
          echo "üîê Testing AWS credentials..."
          aws sts get-caller-identity

      - name: Upload GitHub Secrets to SSM
        run: |
          echo "üîí Uploading secrets to AWS SSM..."
          IFS=',' read -ra SECRET_LIST <<< "$SECRET_NAMES"
          for secret_name in "${SECRET_LIST[@]}"; do
            value="${!secret_name}"
            echo "‚Üí Uploading $secret_name"
            aws ssm put-parameter \
              --name "/test/$secret_name" \
              --value "$value" \
              --type "SecureString" \
              --region "$AWS_REGION" \
              --overwrite
          done

      - name: Upload GitHub Variables to SSM
        run: |
          echo "üìù Uploading variables to AWS SSM..."
          IFS=',' read -ra VAR_LIST <<< "$VAR_NAMES"
          for var_name in "${VAR_LIST[@]}"; do
            value="${!var_name}"
            echo "‚Üí Uploading $var_name"
            aws ssm put-parameter \
              --name "/test/$var_name" \
              --value "$value" \
              --type "String" \
              --region "$AWS_REGION" \
              --overwrite
          done

      - name: Retrieve Uploaded Parameters from SSM
        run: |
          echo "üì• Parameters under /test/:"
          aws ssm get-parameters-by-path \
            --path "/test/" \
            --with-decryption \
            --recursive \
            --query 'Parameters[*].[Name,Type,Value]' \
            --output table
